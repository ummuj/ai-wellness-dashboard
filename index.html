!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport<" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Wellness Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght%40400%3B600%3B700&display=swap" rel="stylesheet">
    <style>
        :root {
            --c-dark-blue: #0A2463;
            --c-mid-blue: #3E92CC;
            --c-bright-red: #D8315B;
            --c-yellow: #FFEC4F;
            --c-white: #FFFFFF;
            --c-light-gray: #f9fafb; 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--c-light-gray);
            color: var(--c-dark-blue);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 280px;
            max-height: 350px;
        }
        @media (min-width: 640px) {
            .chart-container {
                height: 320px;
            }
        }
        .kpi-card {
            background-color: var(--c-white);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .kpi-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--c-mid-blue);
        }
        .kpi-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .form-input {
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--c-mid-blue);
            box-shadow: 0 0 0 3px rgba(62, 146, 204, 0.3);
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--c-dark-blue);
        }
        .btn-primary {
            background-color: var(--c-mid-blue);
            color: var(--c-white);
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #337ab8;
        }
        .btn-secondary {
            background-color: var(--c-light-gray);
            color: var(--c-dark-blue);
            border: 1px solid var(--c-mid-blue);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--c-mid-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-3xl font-bold text-center" style="color: var(--c-dark-blue);">
                AI-Powered Wellness Dashboard
            </h1>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section id="form-section" class="bg-white p-6 sm:p-8 rounded-lg shadow-xl max-w-3xl mx-auto transition-opacity duration-500">
            <h2 class="text-2xl font-bold mb-4 text-center" style="color: var(--c-dark-blue);">
                Log Your Daily Wellness
            </h2>
            <p class="text-center text-gray-600 mb-8">
                Fill out your metrics for today to generate your personalized dashboard and AI summary.
            </p>
            
            <form id="wellness-form" class="space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="sleep-hours" class="form-label">Sleep (Hours)</label>
                        <input type="number" id="sleep-hours" name="sleep-hours" class="form-input" min="0" max="24" step="0.5" value="7.5" required>
                    </div>
                    <div>
                        <label for="sleep-quality" class="form-label">Sleep Quality (1-10)</label>
                        <input type="range" id="sleep-quality" name="sleep-quality" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="10" value="7" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="stress-level" class="form-label">Stress Level (1-10)</label>
                        <input type="range" id="stress-level" name="stress-level" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="10" value="4" required>
                    </div>
                    <div>
                        <label for="mood" class="form-label">Overall Mood</label>
                        <select id="mood" name="mood" class="form-input">
                            <option value="Happy">Happy (üòä)</option>
                            <option value="Neutral" selected>Neutral (üòê)</option>
                            <option value="Sad">Sad (üòî)</option>
                            <option value="Anxious">Anxious (üòü)</option>
                            <option value="Energized">Energized (‚ö°)</option>
                        </select>
                    </div>
                </div>
                
                <hr class="my-6">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="steps" class="form-label">Steps Taken</label>
                        <input type="number" id="steps" name="steps" class="form-input" min="0" value="6500" required>
                    </div>
                    <div>
                        <label for="exercise-minutes" class="form-label">Exercise (Minutes)</label>
                        <input type="number" id="exercise-minutes" name="exercise-minutes" class="form-input" min="0" value="30" required>
                    </div>
                    <div>
                        <label for="exercise-type" class="form-label">Type of Exercise</label>
                        <select id="exercise-type" name="exercise-type" class="form-input" required>
                            <option value="Cardio">Cardio (e.g., Running, Cycling)</option>
                            <option value="Strength" selected>Strength (e.g., Weights, Bodyweight)</option>
                            <option value="Flexibility">Flexibility (e.g., Yoga, Stretching)</option>
                            <option value="Sport">Sport (e.g., Basketball, Soccer)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <hr class="my-6">

                <div>
                    <h3 class="text-lg font-semibold mb-3">Nutrition Input</h3>
                    <div class="space-y-4 mb-4 p-4 border rounded-lg bg-gray-50">
                        <label for="food-image" class="form-label">Estimate from Photo (Optional)</label>
                        <input type="file" id="food-image" accept="image/*" class="w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100 cursor-pointer
                        ">
                        <button type="button" id="analyze-button" class="btn-secondary flex items-center justify-center space-x-2 w-full">
                            <span id="analysis-text">Analyze Food Photo</span>
                            <div id="analysis-spinner" class="hidden loading-spinner"></div>
                        </button>
                        <p id="analysis-message" class="text-sm text-gray-600 mt-2 h-4"></p>
                    </div>

                    <h3 class="text-lg font-semibold mb-3">Manual Nutrition Entry</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="calories" class="form-label text-sm">Calories</label>
                            <input type="number" id="calories" name="calories" class="form-input" min="0" value="2100">
                        </div>
                        <div>
                            <label for="protein" class="form-label text-sm">Protein (g)</label>
                            <input type="number" id="protein" name="protein" class="form-input" min="0" value="120">
                        </div>
                        <div>
                            <label for="carbs" class="form-label text-sm">Carbs (g)</label>
                            <input type="number" id="carbs" name="carbs" class="form-input" min="0" value="250">
                        </div>
                        <div>
                            <label for="fat" class="form-label text-sm">Fat (g)</label>
                            <input type="number" id="fat" name="fat" class="form-input" min="0" value="70">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="water-glasses" class="form-label">Water Intake (8oz Glasses)</label>
                        <input type="number" id="water-glasses" name="water-glasses" class="form-input" min="0" value="6" required>
                    </div>
                    <div>
                        <label for="weight" class="form-label">Today's Weight (kg)</label>
                        <input type="number" id="weight" name="weight" class="form-input" min="0" step="0.1" value="70.5" required>
                    </div>
                </div>

                <div class="text-center pt-4">
                    <button type="submit" class="btn-primary w-full sm:w-auto">
                        Generate My Dashboard & Insights
                    </button>
                </div>
            </form>
        </section>

        <section id="dashboard-section" class="hidden space-y-12 transition-opacity duration-500">

            <!-- New AI Insight Section -->
            <div id="ai-insight-card" class="bg-indigo-50 p-6 rounded-lg shadow-2xl border-2 border-indigo-200">
                <h2 class="text-3xl font-bold mb-4 flex items-center" style="color: var(--c-dark-blue);">
                    <span class="mr-3 text-indigo-600">üß†</span> AI-Powered Insight
                </h2>
                <div id="ai-insight-content">
                    <!-- Content will be injected here -->
                    <div class="flex items-center space-x-3 text-indigo-600 font-semibold">
                        <div class="loading-spinner"></div>
                        <span>Analyzing data and generating personalized summary...</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4" style="color: var(--c-dark-blue);">
                    At a Glance: Today's Vitals
                </h2>
                <p class="text-gray-600 mb-6">
                    Here is your high-level summary for today based on the data you provided.
                </p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="kpi-card">
                        <div id="kpi-sleep" class="kpi-value">...</div>
                        <div class="kpi-label">Hours Slept</div>
                    </div>
                    <div class="kpi-card">
                        <div id="kpi-steps" class="kpi-value">...</div>
                        <div class="kpi-label">Steps Taken</div>
                    </div>
                    <div class="kpi-card">
                        <div id="kpi-calories" class="kpi-value">...</div>
                        <div class="kpi-label">Calories In</div>
                    </div>
                    <div class="kpi-card">
                        <div id="kpi-weight" class="kpi-value">...</div>
                        <div class="kpi-label">Weight (kg)</div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4" style="color: var(--c-dark-blue);">
                    Wellness & Mood
                </h2>
                <p class="text-gray-600 mb-6">
                    This section covers your restorative metrics: sleep, stress, and hydration.
                </p>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-center mb-3">Sleep Quality</h3>
                        <div class="chart-container" style="height: 250px; max-height: 300px;">
                            <canvas id="sleepQualityChart"></canvas>
                        </div>
                        <p id="sleep-quality-text" class="text-center text-sm text-gray-600 mt-4">...</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-center mb-3">Stress Level</h3>
                        <div class="chart-container" style="height: 250px; max-height: 300px;">
                            <canvas id="stressChart"></canvas>
                        </div>
                        <p id="stress-level-text" class="text-center text-sm text-gray-600 mt-4">...</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner space-y-6">
                        <div>
                            <h3 class="font-semibold text-center mb-3">Mood</h3>
                            <div id="mood-display" class="text-7xl text-center">...</div>
                            <p id="mood-text" class="text-center font-semibold text-xl" style="color: var(--c-mid-blue);">...</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-center mb-3">Hydration</h3>
                            <div id="water-display" class="text-4xl text-center flex flex-wrap justify-center gap-2">
                            </div>
                            <p id="water-text" class="text-center text-sm text-gray-600 mt-4">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4" style="color: var(--c-dark-blue);">
                    Physical Activity
                </h2>
                <p class="text-gray-600 mb-6">
                    Visualizing your movement and exercise against common daily targets.
                </p>
                <div class="text-center bg-blue-50 p-3 rounded-lg mb-6 shadow-sm">
                    <span class="text-md font-semibold text-gray-700">Today's Logged Activity:</span>
                    <span id="exercise-type-display" class="text-xl font-bold ml-2" style="color: var(--c-dark-blue);">...</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-center mb-3">Steps vs. 10k Goal</h3>
                        <div class="chart-container">
                            <canvas id="stepsChart"></canvas>
                        </div>
                        <p id="steps-text" class="text-center text-sm text-gray-600 mt-4">...</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-center mb-3">Exercise vs. 30min Goal</h3>
                        <div class="chart-container">
                            <canvas id="exerciseChart"></canvas>
                        </div>
                        <p id="exercise-text" class="text-center text-sm text-gray-600 mt-4">...</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4" style="color: var(--c-dark-blue);">
                    Nutrition & Trends
                </h2>
                <p class="text-gray-600 mb-6">
                    A look at your macronutrient balance and a sample of how your weight trend could look over time.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-center mb-3">Macronutrient Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="macroChart"></canvas>
                        </div>
                        <p id="macro-text" class="text-center text-sm text-gray-600 mt-4">...</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h3 class="font-semibold text-center mb-3">Weight Trend (Sample)</h3>
                        <div class="chart-container">
                            <canvas id="weightTrendChart"></canvas>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-4">This is a sample trend. Keep logging daily to see your own progress!</p>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <footer class="text-center p-8 mt-12 text-gray-500 text-sm">
        A dynamic infographic SPA created with HTML, Tailwind CSS, and Chart.js. Now featuring AI-Powered insights via the Gemini API!
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wellnessForm = document.getElementById('wellness-form');
            const formSection = document.getElementById('form-section');
            const dashboardSection = document.getElementById('dashboard-section');
            const foodImageInput = document.getElementById('food-image');
            const analyzeButton = document.getElementById('analyze-button');
            const analysisText = document.getElementById('analysis-text');
            const analysisSpinner = document.getElementById('analysis-spinner');
            const analysisMessage = document.getElementById('analysis-message');
            const aiInsightContent = document.getElementById('ai-insight-content');

            // ‚ö†Ô∏è SECURITY WARNING: 
            // In a real, shared application, NEVER hardcode your API key here.
            // This is only for local testing or within a secure environment.
            // For GitHub Pages, use a proxy/serverless function to hide the key.
            // Replace 'YOUR_GEMINI_API_KEY_HERE' with your key for local testing.
            const apiKey = ""; // Keep this as an empty string when sharing the code.

            // --- API Configuration ---
            const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            const MAX_RETRIES = 5;

            const chartColors = {
                blue: 'rgba(62, 146, 204, 0.8)',
                blue_bg: 'rgba(62, 146, 204, 0.2)',
                red: 'rgba(216, 49, 91, 0.8)',
                red_bg: 'rgba(216, 49, 91, 0.2)',
                yellow: 'rgba(255, 236, 79, 0.8)',
                yellow_bg: 'rgba(255, 236, 79, 0.2)',
                dark_blue: 'rgba(10, 36, 99, 0.8)',
                gray: 'rgba(229, 231, 235, 1)'
            };

            const tooltipPlugin = {
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const item = tooltipItems[0];
                                let label = item.chart.data.labels[item.dataIndex];
                                if (Array.isArray(label)) {
                                  return label.join(' ');
                                } else {
                                  return label;
                                }
                            }
                        }
                    },
                    legend: {
                        labels: {
                            font: { family: 'Inter' }
                        }
                    }
                }
            };

            function wrapLabels(label, maxWidth = 16) {
                if (label.length <= maxWidth) {
                    return label;
                }
                const words = label.split(' ');
                const lines = [];
                let currentLine = '';
                for (const word of words) {
                    if ((currentLine + word).length <= maxWidth) {
                        currentLine += word + ' ';
                    } else {
                        lines.push(currentLine.trim());
                        currentLine = word + ' ';
                    }
                }
                lines.push(currentLine.trim());
                return lines;
            }

            // --- LLM API Call Utility ---
            const fetchWithRetry = async (url, options) => {
                let delay = 1000;
                for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            if (response.status === 429 && attempt < MAX_RETRIES) {
                                throw new Error('Too Many Requests (429)');
                            }
                            const errorBody = await response.json().catch(() => ({}));
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorBody.error?.message || 'Unknown error'}`);
                        }
                        return await response.json();
                    } catch (error) {
                        if (attempt === MAX_RETRIES) {
                            console.error("API call failed after max retries:", error);
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            };


            // --- Feature 1: Image-to-JSON Nutrition Analysis ---
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            async function analyzeFoodImage(base64Data, mimeType) {
                if (apiKey === "") {
                    analysisMessage.textContent = 'API Key missing. Cannot run image analysis on a public deployment.';
                    return null;
                }
                analysisText.textContent = 'Analyzing...';
                analysisSpinner.classList.remove('hidden');
                analyzeButton.disabled = true;
                analysisMessage.textContent = 'Please wait, analyzing image...';
                
                const userPrompt = "Analyze this image of food and provide an estimate of its macronutrients and calories in JSON format. Provide all values as integers (e.g., 50, not 50.5 or 50g). If you cannot determine a value, use 0. Return ONLY the JSON object, no introductory text.";
                
                const jsonSchema = {
                    type: "OBJECT",
                    properties: {
                        "calories": { "type": "INTEGER", "description": "Estimated total calories." },
                        "protein": { "type": "INTEGER", "description": "Estimated protein in grams." },
                        "carbs": { "type": "INTEGER", "description": "Estimated carbohydrates in grams." },
                        "fat": { "type": "INTEGER", "description": "Estimated fat in grams." }
                    },
                    required: ["calories", "protein", "carbs", "fat"]
                };

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userPrompt },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: jsonSchema
                    }
                };

                try {
                    const result = await fetchWithRetry(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (jsonString) {
                        return JSON.parse(jsonString);
                    }
                    return null;

                } catch (error) {
                    throw new Error(`Food analysis failed: ${error.message}`);
                }
            }

            foodImageInput.addEventListener('change', () => {
                analyzeButton.disabled = foodImageInput.files.length === 0;
                analysisMessage.textContent = foodImageInput.files.length > 0 ? `${foodImageInput.files[0].name} ready for analysis.` : '';
            });

            analyzeButton.addEventListener('click', async () => {
                const file = foodImageInput.files[0];
                if (!file) {
                    analysisMessage.textContent = 'Please select a food image first.';
                    return;
                }
                if (apiKey === "") {
                    analysisMessage.textContent = 'API Key is missing. Check instructions for deployment!';
                    return;
                }

                try {
                    const base64Data = await fileToBase64(file);
                    const mimeType = file.type;
                    
                    const nutritionData = await analyzeFoodImage(base64Data, mimeType);

                    if (nutritionData) {
                        document.getElementById('calories').value = nutritionData.calories || 0;
                        document.getElementById('protein').value = nutritionData.protein || 0;
                        document.getElementById('carbs').value = nutritionData.carbs || 0;
                        document.getElementById('fat').value = nutritionData.fat || 0;
                        analysisMessage.textContent = `Analysis complete! Estimated ${nutritionData.calories} calories loaded into form.`;
                    } else {
                        analysisMessage.textContent = 'Could not parse nutrition data. Please try another image.';
                    }
                } catch (error) {
                    console.error("Food Analysis Error:", error);
                    analysisMessage.textContent = `An error occurred: ${error.message}.`;
                } finally {
                    analysisText.textContent = 'Analyze Food Photo';
                    analysisSpinner.classList.add('hidden');
                    analyzeButton.disabled = false;
                }
            });


            // --- Feature 2: LLM Wellness Insight Generation (New Feature) ---

            async function generateWellnessInsight(data) {
                aiInsightContent.innerHTML = `
                    <div class="flex items-center space-x-3 text-indigo-600 font-semibold">
                        <div class="loading-spinner"></div>
                        <span>Analyzing data and generating personalized summary...</span>
                    </div>
                `;

                if (apiKey === "") {
                    aiInsightContent.innerHTML = `<p class="text-red-500 font-semibold">
                        ‚ö†Ô∏è API Key is missing. The AI Insight feature will not work until you deploy securely with a proxy or add your key locally. See the deployment instructions.
                    </p>`;
                    return;
                }


                // System Instruction to define the AI's role and output format
                const systemPrompt = "Act as a friendly, motivational, and expert wellness coach. Based on the user's daily metrics, provide a personalized, concise, single-paragraph summary of their day's performance (identifying 1-2 strengths and 1 area for improvement) and give one specific, actionable tip for tomorrow. Do not use markdown headers, lists, or bullet points. The advice must be contextually relevant to the lowest-performing metric.";

                // User Query containing all the collected data
                const userQuery = `
                    Generate a wellness insight for the following metrics:
                    - Sleep: ${data.sleepHours} hours (Quality: ${data.sleepQuality}/10)
                    - Stress Level: ${data.stressLevel}/10
                    - Mood: ${data.mood}
                    - Activity: ${data.steps} steps, ${data.exerciseMinutes} mins of ${data.exerciseType}
                    - Nutrition: ${data.calories} Calories, ${data.protein}g Protein, ${data.carbs}g Carbs, ${data.fat}g Fat
                    - Hydration: ${data.waterGlasses} glasses
                    - Weight: ${data.weight} kg
                `;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    // Using Google Search grounding to ensure advice is grounded in current wellness knowledge
                    tools: [{ "google_search": {} }],
                };

                try {
                    const result = await fetchWithRetry(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 
                                 "Could not generate a personalized insight. Please check your network connection or try again later.";
                    
                    // Display the generated text
                    aiInsightContent.innerHTML = `<p class="text-gray-800 leading-relaxed">${text}</p>`;

                } catch (error) {
                    console.error("Gemini Insight Error:", error);
                    aiInsightContent.innerHTML = `<p class="text-red-500">Error generating AI Insight: ${error.message}. Ensure your API key is correctly configured.</p>`;
                }
            }


            // --- Main Form Submission Handler ---
            wellnessForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const formData = new FormData(wellnessForm);
                const data = {
                    sleepHours: parseFloat(formData.get('sleep-hours')),
                    sleepQuality: parseInt(formData.get('sleep-quality')),
                    stressLevel: parseInt(formData.get('stress-level')),
                    mood: formData.get('mood'),
                    steps: parseInt(formData.get('steps')),
                    exerciseMinutes: parseInt(formData.get('exercise-minutes')),
                    exerciseType: formData.get('exercise-type'),
                    calories: parseInt(formData.get('calories')),
                    protein: parseInt(formData.get('protein')),
                    carbs: parseInt(formData.get('carbs')),
                    fat: parseInt(formData.get('fat')),
                    waterGlasses: parseInt(formData.get('water-glasses')),
                    weight: parseFloat(formData.get('weight')),
                };
                
                formSection.style.opacity = 0;
                setTimeout(() => {
                    formSection.classList.add('hidden');
                    dashboardSection.classList.remove('hidden');
                    dashboardSection.style.opacity = 1;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    initDashboard(data);
                    generateWellnessInsight(data); // <--- CALL THE LLM FEATURE
                }, 500);
            });


            // --- Dashboard Initialization (Visualizations) ---
            function initDashboard(data) {
                document.getElementById('kpi-sleep').textContent = data.sleepHours.toFixed(1);
                document.getElementById('kpi-steps').textContent = data.steps.toLocaleString();
                document.getElementById('kpi-calories').textContent = data.calories.toLocaleString();
                document.getElementById('kpi-weight').textContent = data.weight.toFixed(1);
                
                document.getElementById('exercise-type-display').textContent = data.exerciseType;

                createSleepQualityChart(data.sleepQuality);
                createStressChart(data.stressLevel);
                displayMoodAndWater(data.mood, data.waterGlasses);
                createStepsChart(data.steps);
                createExerciseChart(data.exerciseMinutes);
                createMacroChart(data.protein, data.carbs, data.fat);
                createWeightTrendChart();
            }

            function createSleepQualityChart(quality) {
                const existingChart = Chart.getChart('sleepQualityChart');
                if (existingChart) existingChart.destroy();
                const ctx = document.getElementById('sleepQualityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Quality', 'Remaining'],
                        datasets: [{
                            data: [quality, 10 - quality],
                            backgroundColor: [chartColors.blue, chartColors.gray],
                            borderColor: [chartColors.blue, chartColors.gray],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: { ...tooltipPlugin.plugins,
                            legend: { display: false }
                        }
                    }
                });
                document.getElementById('sleep-quality-text').textContent = `You rated your sleep quality ${quality} out of 10.`;
            }

            function createStressChart(level) {
                const existingChart = Chart.getChart('stressChart');
                if (existingChart) existingChart.destroy();
                const ctx = document.getElementById('stressChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Stress Level', 'Remaining'],
                        datasets: [{
                            data: [level, 10 - level],
                            backgroundColor: [chartColors.red, chartColors.gray],
                            borderColor: [chartColors.red, chartColors.gray],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        circumference: 180,
                        rotation: 270,
                        cutout: '70%',
                        plugins: { ...tooltipPlugin.plugins,
                            legend: { display: false }
                        }
                    }
                });
                let stressText = 'Your stress level is low.';
                if (level > 4) stressText = 'Your stress level is moderate.';
                if (level > 7) stressText = 'Your stress level is high.';
                document.getElementById('stress-level-text').textContent = `You rated your stress ${level} out of 10. ${stressText}`;
            }

            function displayMoodAndWater(mood, water) {
                const moodMap = {
                    'Happy': 'üòä',
                    'Neutral': 'üòê',
                    'Sad': 'üòî',
                    'Anxious': 'üòü',
                    'Energized': '‚ö°'
                };
                document.getElementById('mood-display').textContent = moodMap[mood] || 'üòê';
                document.getElementById('mood-text').textContent = mood;

                const waterTarget = 8;
                let waterIcons = '';
                for(let i = 0; i < waterTarget; i++) {
                    waterIcons += `<span style="color: ${i < water ? 'var(--c-mid-blue)' : '#D1D5DB'}">üíß</span>`;
                }
                document.getElementById('water-display').innerHTML = waterIcons;
                document.getElementById('water-text').textContent = `You've had ${water} of ${waterTarget} glasses of water.`;
            }

            function createStepsChart(steps) {
                const existingChart = Chart.getChart('stepsChart');
                if (existingChart) existingChart.destroy();
                const ctx = document.getElementById('stepsChart').getContext('2d');
                const target = 10000;
                const remaining = Math.max(0, target - steps);
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Steps Taken', 'Remaining'],
                        datasets: [{
                            data: [steps, remaining],
                            backgroundColor: [chartColors.blue, chartColors.gray],
                            borderColor: [chartColors.blue, chartColors.gray],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: { ...tooltipPlugin.plugins,
                            legend: { position: 'bottom' }
                        }
                    }
                });
                let stepsText = `You're ${Math.round((steps/target)*100)}% of the way to your goal!`;
                if (steps >= target) stepsText = `Great job! You've exceeded your 10,000 step goal.`;
                document.getElementById('steps-text').textContent = stepsText;
            }

            function createExerciseChart(minutes) {
                const existingChart = Chart.getChart('exerciseChart');
                if (existingChart) existingChart.destroy();
                const ctx = document.getElementById('exerciseChart').getContext('2d');
                const target = 30;
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [
                            wrapLabels('Logged Exercise Minutes'), 
                            wrapLabels('Daily Target Minutes')
                        ],
                        datasets: [{
                            label: 'Minutes',
                            data: [minutes, target],
                            backgroundColor: [chartColors.blue_bg, chartColors.red_bg],
                            borderColor: [chartColors.blue, chartColors.red],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { ...tooltipPlugin.plugins,
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                let exerciseText = `You logged ${minutes} minutes of exercise.`;
                if (minutes >= target) exerciseText += ` You've hit the 30-minute target!`;
                document.getElementById('exercise-text').textContent = exerciseText;
            }

            function createMacroChart(protein, carbs, fat) {
                const existingChart = Chart.getChart('macroChart');
                if (existingChart) existingChart.destroy();
                const ctx = document.getElementById('macroChart').getContext('2d');
                const total = protein + carbs + fat;
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Protein (g)', 'Carbs (g)', 'Fat (g)'],
                        datasets: [{
                            data: [protein, carbs, fat],
                            backgroundColor: [chartColors.blue, chartColors.yellow, chartColors.red],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { ...tooltipPlugin.plugins,
                            legend: { position: 'bottom' }
                        }
                    }
                });
                document.getElementById('macro-text').textContent = `Total macros: ${total.toFixed(0)}g`;
            }

            function createWeightTrendChart() {
                const existingChart = Chart.getChart('weightTrendChart');
                if (existingChart) existingChart.destroy();
                const ctx = document.getElementById('weightTrendChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Today'],
                        datasets: [{
                            label: 'Weight (kg)',
                            data: [71.2, 71.0, 70.8, 70.9, 70.5, 70.6, document.getElementById('weight').value],
                            fill: true,
                            backgroundColor: chartColors.blue_bg,
                            borderColor: chartColors.blue,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { ...tooltipPlugin.plugins,
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
